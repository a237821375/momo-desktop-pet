<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è®¾ç½® - Desktop Pet AI</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #fff;
      padding: 20px;
      overflow-y: auto;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 30px;
      text-align: center;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .section {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .section-title {
      font-size: 20px;
      margin-bottom: 15px;
      color: #fff;
      border-bottom: 2px solid rgba(255, 255, 255, 0.3);
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.9);
    }

    input[type="text"],
    input[type="password"],
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    select:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.2);
    }

    select option {
      background: #2a5298;
      color: #fff;
    }

    /* optgroup åˆ†ç»„æ ‡ç­¾æ ·å¼ - åŠ å¼ºå¯¹æ¯”åº¦ */
    select optgroup {
      background: #1e3c72;
      color: #ffd700;
      font-weight: bold;
      font-size: 14px;
      font-style: normal;
    }

    /* optgroup ä¸‹çš„é€‰é¡¹ */
    select optgroup option {
      background: #3a5ba8;
      color: #fff;
      padding-left: 20px;
      font-weight: normal;
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    button {
      flex: 1;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .hint {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 5px;
    }

    .status {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      display: none;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .status.success {
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: #fff;
      display: block;
    }

    .status.error {
      background: linear-gradient(135deg, #f44336 0%, #e53935 100%);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: #fff;
      display: block;
    }

    .config-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 200px;
      overflow-y: auto;
    }

    .subsection {
      margin-top: 20px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
    }

    .subsection-title {
      font-size: 16px;
      margin-bottom: 15px;
      color: rgba(255, 255, 255, 0.9);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 8px;
    }

    .provider-config {
      margin-bottom: 15px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
    }

    .provider-header-simple {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .provider-icon {
      font-size: 20px;
    }

    .provider-name {
      font-size: 16px;
      font-weight: 600;
    }

    .provider-content {
      padding: 15px;
      background: rgba(0, 0, 0, 0.1);
    }

    .toggle-icon {
      transition: transform 0.3s;
    }

    .toggle-icon.open {
      transform: rotate(180deg);
    }

    .status-badge {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
    }

    .status-badge.configured {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
    }

    .model-list {
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
    }

    .model-list h4 {
      margin-bottom: 10px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
    }

    .model-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      transition: all 0.2s;
    }

    .model-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .model-item.selected {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.15);
    }

    .model-info {
      flex: 1;
    }

    .model-name {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .model-meta {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
    }

    .config-info {
      flex: 1;
    }

    .config-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .config-detail {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
    }

    .config-tags {
      display: flex;
      gap: 4px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      font-size: 10px;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.15);
      color: rgba(255, 255, 255, 0.8);
    }

    .tag.primary {
      background: rgba(102, 126, 234, 0.3);
      color: #a8b4ff;
    }

    .config-actions {
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .btn-small:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .btn-small.danger {
      background: rgba(244, 67, 54, 0.2);
      border-color: rgba(244, 67, 54, 0.5);
    }

    .btn-small.danger:hover {
      background: rgba(244, 67, 54, 0.3);
    }

    .btn-add {
      width: 100%;
      padding: 10px;
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid rgba(76, 175, 80, 0.5);
      border-radius: 6px;
      color: #4caf50;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .btn-add:hover {
      background: rgba(76, 175, 80, 0.3);
      transform: translateY(-2px);
    }

    /* éŸ³è‰²åˆ—è¡¨æ ·å¼ */
    .voice-list {
      max-height: 400px;
      overflow-y: auto;
      padding: 10px 0;
    }

    .voice-group-title {
      font-size: 13px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 8px;
      padding-bottom: 5px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .voice-item {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      margin-bottom: 6px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      transition: all 0.2s;
    }

    .voice-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .voice-item input[type="radio"] {
      margin-right: 10px;
      cursor: pointer;
    }

    .voice-item label {
      flex: 1;
      margin: 0;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-voice-test {
      padding: 4px 12px;
      background: rgba(102, 126, 234, 0.3);
      border: 1px solid rgba(102, 126, 234, 0.5);
      border-radius: 4px;
      color: #a8b4ff;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .btn-voice-test:hover {
      background: rgba(102, 126, 234, 0.5);
    }

    .btn-voice-test:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Tab æ ·å¼ */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }

    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.6);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
      position: relative;
      bottom: -2px;
    }

    .tab:hover {
      color: rgba(255, 255, 255, 0.9);
    }

    .tab.active {
      color: #fff;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      border-radius: 12px;
      padding: 30px;
      width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .modal-title {
      font-size: 22px;
      margin-bottom: 20px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>âš™ï¸ è®¾ç½®</h1>

    <!-- Tab å¯¼èˆª -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('llm')">ğŸ¤– LLM è®¾ç½®</button>
      <button class="tab" onclick="switchTab('tts')">ğŸ”Š TTS è®¾ç½®</button>
    </div>

    <!-- LLM Tab å†…å®¹ -->
    <div id="tab-llm" class="tab-content active">
      <div class="section">
        <!-- ç¬¬ä¸€å—ï¼šæ¨¡å‹æä¾›å•†é…ç½® -->
        <div class="subsection">
          <h3 class="subsection-title">æ¨¡å‹æä¾›å•†é…ç½®</h3>
          
          <!-- åƒé—® -->
          <div class="provider-config">
            <div class="provider-header-simple">
              <span class="provider-icon">ğŸ’¬</span>
              <span class="provider-name">é€šä¹‰åƒé—®</span>
              <span id="qwen-status" class="status-badge">æœªé…ç½®</span>
            </div>
            <div class="form-group">
              <label for="qwen-api-key">API Key</label>
              <input type="password" id="qwen-api-key" placeholder="è¯·è¾“å…¥åƒé—® API Key">
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn-small btn-primary" onclick="saveProvider('qwen')">ğŸ’¾ ä¿å­˜</button>
              <button class="btn-small" onclick="refreshModels('qwen')">ğŸ”„ åˆ·æ–°æ¨¡å‹</button>
            </div>
            <p class="hint" id="qwen-hint"></p>
          </div>

          <!-- OpenRouter -->
          <div class="provider-config">
            <div class="provider-header-simple">
              <span class="provider-icon">ğŸŒ</span>
              <span class="provider-name">OpenRouter</span>
              <span id="openrouter-status" class="status-badge">æœªé…ç½®</span>
            </div>
            <div class="form-group">
              <label for="openrouter-api-key">API Key</label>
              <input type="password" id="openrouter-api-key" placeholder="è¯·è¾“å…¥ OpenRouter API Key">
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn-small btn-primary" onclick="saveProvider('openrouter')">ğŸ’¾ ä¿å­˜</button>
              <button class="btn-small" onclick="refreshModels('openrouter')">ğŸ”„ åˆ·æ–°æ¨¡å‹</button>
            </div>
            <p class="hint" id="openrouter-hint"></p>
          </div>
        </div>

        <!-- ç¬¬äºŒå—ï¼šå½“å‰ä½¿ç”¨çš„æ¨¡å‹ -->
        <div class="subsection">
          <h3 class="subsection-title">å½“å‰ä½¿ç”¨çš„æ¨¡å‹</h3>
          
          <div class="form-group">
            <label for="llm-model">é€‰æ‹©æ¨¡å‹</label>
            <select id="llm-model">
              <option value="">-- è¯·å…ˆé…ç½®å¹¶åˆ·æ–°æ¨¡å‹ --</option>
            </select>
            <p class="hint" id="model-hint"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- TTS Tab å†…å®¹ -->
    <div id="tab-tts" class="tab-content">
      <div class="section">
        <div class="form-group">
          <label for="tts-app-id">App ID</label>
          <input type="text" id="tts-app-id" placeholder="è¯·è¾“å…¥ App ID">
        </div>
        
        <div class="form-group">
          <label for="tts-access-token">Access Token</label>
          <input type="password" id="tts-access-token" placeholder="è¯·è¾“å…¥ Access Token">
        </div>

        <div class="form-group">
          <label for="tts-secret-key">Secret Key</label>
          <input type="password" id="tts-secret-key" placeholder="è¯·è¾“å…¥ Secret Key">
        </div>

        <div class="form-group">
          <label for="tts-voice-type">éŸ³è‰²é€‰æ‹©</label>
          <div class="voice-list">
            <!-- V3 å¤§æ¨¡å‹éŸ³è‰² -->
            <div class="voice-group-title">V3 å¤§æ¨¡å‹éŸ³è‰²ï¼ˆæ¨èï¼‰</div>
            <div class="voice-item" data-voice="zh_female_cancan_mars_bigtts">
              <input type="radio" name="voice-select" value="zh_female_cancan_mars_bigtts" id="voice-cancan">
              <label for="voice-cancan">ç¿ç¿ - å¥³å£°</label>
              <button class="btn-voice-test" onclick="testVoice('zh_female_cancan_mars_bigtts')">â–¶ è¯•å¬</button>
            </div>
            <div class="voice-item" data-voice="zh_female_vv_uranus_bigtts">
              <input type="radio" name="voice-select" value="zh_female_vv_uranus_bigtts" id="voice-vivi">
              <label for="voice-vivi">Vivi 2.0 - å¥³å£°ï¼ˆä¸­è‹±ï¼‰</label>
              <button class="btn-voice-test" onclick="testVoice('zh_female_vv_uranus_bigtts')">â–¶ è¯•å¬</button>
            </div>
            <div class="voice-item" data-voice="zh_female_xiaohe_uranus_bigtts">
              <input type="radio" name="voice-select" value="zh_female_xiaohe_uranus_bigtts" id="voice-xiaohe">
              <label for="voice-xiaohe">å°ä½• 2.0 - å¥³å£°ï¼ˆä¸­æ–‡ï¼‰</label>
              <button class="btn-voice-test" onclick="testVoice('zh_female_xiaohe_uranus_bigtts')">â–¶ è¯•å¬</button>
            </div>
            <div class="voice-item" data-voice="zh_male_m191_uranus_bigtts">
              <input type="radio" name="voice-select" value="zh_male_m191_uranus_bigtts" id="voice-yunzhou">
              <label for="voice-yunzhou">äº‘èˆŸ 2.0 - ç”·å£°ï¼ˆä¸­æ–‡ï¼‰</label>
              <button class="btn-voice-test" onclick="testVoice('zh_male_m191_uranus_bigtts')">â–¶ è¯•å¬</button>
            </div>
            <div class="voice-item" data-voice="zh_male_taocheng_uranus_bigtts">
              <input type="radio" name="voice-select" value="zh_male_taocheng_uranus_bigtts" id="voice-xiaotian">
              <label for="voice-xiaotian">å°å¤© 2.0 - ç”·å£°ï¼ˆä¸­æ–‡ï¼‰</label>
              <button class="btn-voice-test" onclick="testVoice('zh_male_taocheng_uranus_bigtts')">â–¶ è¯•å¬</button>
            </div>
            
            <!-- V1 æµå¼éŸ³è‰² -->
            <div class="voice-group-title" style="margin-top: 15px;">V1 ç»å…¸éŸ³è‰²</div>
            <div class="voice-item" data-voice="BV700_V2_streaming">
              <input type="radio" name="voice-select" value="BV700_V2_streaming" id="voice-bv700">
              <label for="voice-bv700">é€šç”¨å¥³å£°</label>
              <button class="btn-voice-test" onclick="testVoice('BV700_V2_streaming')">â–¶ è¯•å¬</button>
            </div>
            <div class="voice-item" data-voice="BV701_V2_streaming">
              <input type="radio" name="voice-select" value="BV701_V2_streaming" id="voice-bv701">
              <label for="voice-bv701">é€šç”¨ç”·å£°</label>
              <button class="btn-voice-test" onclick="testVoice('BV701_V2_streaming')">â–¶ è¯•å¬</button>
            </div>
            <div class="voice-item" data-voice="BV406_streaming">
              <input type="radio" name="voice-select" value="BV406_streaming" id="voice-bv406">
              <label for="voice-bv406">ç¿ç¿ - å¯çˆ±å¥³å£°</label>
              <button class="btn-voice-test" onclick="testVoice('BV406_streaming')">â–¶ è¯•å¬</button>
            </div>
            <div class="voice-item" data-voice="BV407_streaming">
              <input type="radio" name="voice-select" value="BV407_streaming" id="voice-bv407">
              <label for="voice-bv407">ç‚€ç‚€ - æ¸©æŸ”å¥³å£°</label>
              <button class="btn-voice-test" onclick="testVoice('BV407_streaming')">â–¶ è¯•å¬</button>
            </div>
          </div>
          <p class="hint">ç‚¹å‡»è¯•å¬æŒ‰é’®é¢„è§ˆéŸ³è‰²æ•ˆæœ</p>
        </div>
        
        <!-- TTS ä¿å­˜æŒ‰é’® -->
        <button class="btn-primary" id="btn-save-tts" style="width: 100%; margin-top: 15px;">ğŸ’¾ ä¿å­˜ TTS é…ç½®</button>
      </div>
    </div>

    <div class="status" id="status-message"></div>
  </div>

  <script>
    // Tab åˆ‡æ¢
    function switchTab(tabName) {
      // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // æ¿€æ´»å½“å‰ Tab
      event.target.classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }
    // Provider çŠ¶æ€ç®¡ç†
    let providers = {
      qwen: { apiKey: '', models: [] },
      openrouter: { apiKey: '', models: [] }
    };
    let currentModel = '';

    // è·å– TTS é…ç½®çš„è¾…åŠ©å‡½æ•°
    function getTTSConfig() {
      const selectedVoice = document.querySelector('input[name="voice-select"]:checked');
      const voiceType = selectedVoice ? selectedVoice.value : 'zh_female_cancan_mars_bigtts';
      return {
        appId: document.getElementById('tts-app-id')?.value?.trim() || '',
        accessToken: document.getElementById('tts-access-token')?.value?.trim() || '',
        secretKey: document.getElementById('tts-secret-key')?.value?.trim() || '',
        voiceType: voiceType,
        resourceId: getResourceId(voiceType)  // è‡ªåŠ¨è·å–
      };
    }

    // ä¿å­˜æä¾›å•†é…ç½®ï¼ˆé»˜è®¤åˆ·æ–°æ¨¡å‹ï¼‰
    window.saveProvider = async (provider) => {
      const apiKeyInput = document.getElementById(`${provider}-api-key`);
      const apiKey = apiKeyInput.value.trim();
      
      if (!apiKey) {
        alert('è¯·è¾“å…¥ API Key');
        return;
      }

      providers[provider].apiKey = apiKey;
      
      // ç«‹å³ä¿å­˜åˆ°ä¸»è¿›ç¨‹
      try {
        const settings = {
          qwenApiKey: providers.qwen.apiKey,
          qwenModels: providers.qwen.models,
          openrouterApiKey: providers.openrouter.apiKey,
          openrouterModels: providers.openrouter.models,
          currentModel: document.getElementById('llm-model')?.value || '',
          tts: getTTSConfig()
        };
        
        await window.electronAPI.saveSettings(settings);
        showStatus(`${provider === 'qwen' ? 'åƒé—®' : 'OpenRouter'} API Key å·²ä¿å­˜`, 'success');
        
        // é»˜è®¤åˆ·æ–°ä¸€æ¬¡æ¨¡å‹
        await refreshModels(provider);
      } catch (error) {
        showStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
      }
    };

    // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
    window.refreshModels = async (provider) => {
      const apiKey = providers[provider].apiKey;
      const hint = document.getElementById(`${provider}-hint`);
      const statusBadge = document.getElementById(`${provider}-status`);
      
      if (!apiKey) {
        alert('è¯·å…ˆä¿å­˜ API Key');
        return;
      }

      hint.textContent = 'æ­£åœ¨åŠ è½½æ¨¡å‹åˆ—è¡¨...';
      hint.style.color = 'rgba(255, 255, 255, 0.7)';

      try {
        // åŠ è½½æ¨¡å‹
        await loadModels(provider, apiKey);
        
        // æ›´æ–°çŠ¶æ€
        statusBadge.textContent = `å·²é…ç½® (${providers[provider].models.length} ä¸ªæ¨¡å‹)`;
        statusBadge.classList.add('configured');
        
        hint.textContent = `âœ… å·²åŠ è½½ ${providers[provider].models.length} ä¸ªæ¨¡å‹`;
        hint.style.color = '#4caf50';
        
        // æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨
        renderAllModels();
        
        // ä¿å­˜æ¨¡å‹åˆ—è¡¨åˆ°ä¸»è¿›ç¨‹
        const settings = {
          qwenApiKey: providers.qwen.apiKey,
          qwenModels: providers.qwen.models,
          openrouterApiKey: providers.openrouter.apiKey,
          openrouterModels: providers.openrouter.models,
          currentModel: document.getElementById('llm-model')?.value || '',
          tts: getTTSConfig()
        };
        await window.electronAPI.saveSettings(settings);
        
        showStatus(`${provider === 'qwen' ? 'åƒé—®' : 'OpenRouter'} æ¨¡å‹åˆ—è¡¨å·²ç¼“å­˜`, 'success');
      } catch (error) {
        hint.textContent = `âŒ åŠ è½½å¤±è´¥: ${error.message}`;
        hint.style.color = '#f44336';
        showStatus('åŠ è½½æ¨¡å‹å¤±è´¥', 'error');
      }
    };

    // åŠ è½½æ¨¡å‹åˆ—è¡¨
    async function loadModels(provider, apiKey) {
      const urls = {
        qwen: 'https://dashscope.aliyuncs.com/compatible-mode/v1/models',
        openrouter: 'https://openrouter.ai/api/v1/models'
      };

      const response = await fetch(urls[provider], {
        headers: { 'Authorization': `Bearer ${apiKey}` }
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const data = await response.json();
      providers[provider].models = data.data || [];
    }

    // æ¸²æŸ“æ‰€æœ‰æ¨¡å‹ï¼ˆæŒ‰æä¾›å•†åˆ†ç»„ï¼‰
    function renderAllModels() {
      const select = document.getElementById('llm-model');
      select.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹</option>';

      // é€šä¹‰åƒé—®åˆ†ç»„
      if (providers.qwen.models.length > 0) {
        const group = document.createElement('optgroup');
        group.label = 'é€šä¹‰åƒé—®';
        
        providers.qwen.models.forEach(model => {
          const option = document.createElement('option');
          option.value = `qwen:${model.id}`;
          option.textContent = model.id;
          group.appendChild(option);
        });
        
        select.appendChild(group);
      }

      // OpenRouter åˆ†ç»„
      if (providers.openrouter.models.length > 0) {
        const group = document.createElement('optgroup');
        group.label = 'OpenRouter';
        
        providers.openrouter.models.forEach(model => {
          const option = document.createElement('option');
          option.value = `openrouter:${model.id}`;
          option.textContent = model.id;
          group.appendChild(option);
        });
        
        select.appendChild(group);
      }
      
      // æ·»åŠ  change äº‹ä»¶ç›‘å¬ - é€‰æ‹©æ¨¡å‹åç«‹å³ç¼“å­˜
      select.removeEventListener('change', onModelChange); // ç§»é™¤æ—§ç›‘å¬å™¨
      select.addEventListener('change', onModelChange);
    }
    
    // æ¨¡å‹é€‰æ‹©å˜åŒ–æ—¶ç«‹å³ä¿å­˜
    async function onModelChange(event) {
      const selectedModel = event.target.value;
      if (!selectedModel) return;
      
      currentModel = selectedModel;
      
      try {
        // ç«‹å³ä¿å­˜å½“å‰é€‰æ‹©çš„æ¨¡å‹
        const settings = {
          qwenApiKey: providers.qwen.apiKey,
          qwenModels: providers.qwen.models,
          openrouterApiKey: providers.openrouter.apiKey,
          openrouterModels: providers.openrouter.models,
          currentModel: selectedModel,
          tts: {
            apiKey: document.getElementById('tts-api-key')?.value?.trim() || '',
            appId: document.getElementById('tts-app-id')?.value?.trim() || '',
            voiceType: document.getElementById('tts-voice-type')?.value?.trim() || 'BV700_V2_streaming'
          }
        };
        
        await window.electronAPI.saveSettings(settings);
        
        const hint = document.getElementById('model-hint');
        hint.textContent = `âœ… å·²é€‰æ‹©: ${selectedModel}`;
        hint.style.color = '#4caf50';
        
        console.log('æ¨¡å‹å·²ç¼“å­˜:', selectedModel);
      } catch (error) {
        console.error('ä¿å­˜æ¨¡å‹å¤±è´¥:', error);
        showStatus('ä¿å­˜æ¨¡å‹å¤±è´¥: ' + error.message, 'error');
      }
    }

    // åŠ è½½é…ç½®
    async function loadSettings() {
      try {
        const settings = await window.electronAPI.getSettings();
        
        // åŠ è½½ API Keys å’Œæ¨¡å‹ç¼“å­˜
        if (settings.qwenApiKey) {
          document.getElementById('qwen-api-key').value = settings.qwenApiKey;
          providers.qwen.apiKey = settings.qwenApiKey;
        }
        if (settings.qwenModels) {
          providers.qwen.models = settings.qwenModels;
          const statusBadge = document.getElementById('qwen-status');
          statusBadge.textContent = `å·²é…ç½® (${providers.qwen.models.length} ä¸ªæ¨¡å‹)`;
          statusBadge.classList.add('configured');
        }
        
        if (settings.openrouterApiKey) {
          document.getElementById('openrouter-api-key').value = settings.openrouterApiKey;
          providers.openrouter.apiKey = settings.openrouterApiKey;
        }
        if (settings.openrouterModels) {
          providers.openrouter.models = settings.openrouterModels;
          const statusBadge = document.getElementById('openrouter-status');
          statusBadge.textContent = `å·²é…ç½® (${providers.openrouter.models.length} ä¸ªæ¨¡å‹)`;
          statusBadge.classList.add('configured');
        }
        
        // æ¸²æŸ“æ¨¡å‹åˆ—è¡¨
        renderAllModels();
        
        // åŠ è½½å½“å‰æ¨¡å‹
        if (settings.currentModel) {
          currentModel = settings.currentModel;
          document.getElementById('llm-model').value = currentModel;
        }
        
        // TTS
        document.getElementById('tts-app-id').value = settings.tts?.appId || '';
        document.getElementById('tts-access-token').value = settings.tts?.accessToken || '';
        document.getElementById('tts-secret-key').value = settings.tts?.secretKey || '';
        
        // åŠ è½½éŸ³è‰²é€‰æ‹©
        const voiceType = settings.tts?.voiceType || 'zh_female_cancan_mars_bigtts';
        const voiceRadio = document.querySelector(`input[value="${voiceType}"]`);
        if (voiceRadio) {
          voiceRadio.checked = true;
        }
      } catch (error) {
        console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
      }
    }
    
    // æ ¹æ®éŸ³è‰²ç±»å‹è‡ªåŠ¨è·å– Resource ID
    function getResourceId(voiceType) {
      // V3 å¤§æ¨¡å‹éŸ³è‰²ï¼ˆ2.0ï¼‰ä½¿ç”¨ seed-tts-2.0
      // ç›®å‰åªæœ‰ uranus_bigtts ç³»åˆ—æ˜¯ 2.0
      const v3Voices = [
        'zh_female_vv_uranus_bigtts',
        'zh_female_xiaohe_uranus_bigtts',
        'zh_male_m191_uranus_bigtts',
        'zh_male_taocheng_uranus_bigtts'
      ];
      
      if (v3Voices.includes(voiceType)) {
        return 'seed-tts-2.0';
      }
      
      // å…¶ä»–æ‰€æœ‰éŸ³è‰²ï¼ˆåŒ…æ‹¬ _mars_bigtts, _moon_bigtts, _emo_* ç­‰ï¼‰éƒ½ä½¿ç”¨ 1.0
      return 'seed-tts-1.0';
    }

    // è¯•å¬éŸ³è‰²
    let currentAudio = null;
    window.testVoice = async function(voiceType) {
      const appId = document.getElementById('tts-app-id').value.trim();
      const accessToken = document.getElementById('tts-access-token').value.trim();
      
      if (!appId || !accessToken) {
        alert('è¯·å…ˆé…ç½® App ID å’Œ Access Token');
        return;
      }
      
      const button = event.target;
      button.disabled = true;
      button.textContent = 'âš™ åˆæˆä¸­...';
      
      try {
        // åœæ­¢å½“å‰æ’­æ”¾
        if (currentAudio) {
          currentAudio.pause();
          currentAudio = null;
        }
        
        // åˆ¤æ–­æ˜¯ V1 è¿˜æ˜¯ V3 éŸ³è‰²
        const isV3Voice = voiceType.includes('bigtts');
        
        if (!isV3Voice) {
          // V1 éŸ³è‰²æš‚ä¸æ”¯æŒè¯•å¬
          alert('V1 éŸ³è‰²è¯•å¬åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œè¯·é€‰æ‹© V3 å¤§æ¨¡å‹éŸ³è‰²è¯•å¬');
          button.textContent = 'â–¶ è¯•å¬';
          button.disabled = false;
          return;
        }
        
        // è°ƒç”¨ V3 TTS API
        const response = await fetch('https://openspeech.bytedance.com/api/v3/tts/unidirectional', {
          method: 'POST',
          headers: {
            'X-Api-App-Id': appId,
            'X-Api-Access-Key': accessToken,
            'Content-Type': 'application/json',
            'Connection': 'keep-alive',
          },
          body: JSON.stringify({
            user: { uid: 'preview_user' },
            req_params: {
              text: 'ä½ å¥½å‘€ï¼Œæˆ‘æ˜¯ momoã€‚çˆ±ä½ å“Ÿ',
              speaker: voiceType,
              audio_params: {
                format: 'mp3',
                sample_rate: 24000,
              },
              additions: JSON.stringify({
                explicit_language: 'zh',
                disable_markdown_filter: true,
              }),
            },
          }),
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('API Error:', errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        // è¯»å–æµå¼å“åº”
        const audioChunks = [];
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';
          
          for (const line of lines) {
            if (!line.trim()) continue;
            
            try {
              const data = JSON.parse(line);
              if (data.code === 0 && data.data) {
                const audioBuffer = Uint8Array.from(atob(data.data), c => c.charCodeAt(0));
                audioChunks.push(audioBuffer);
              }
              if (data.code === 20000000) break;
              if (data.code > 0 && data.code !== 20000000) {
                throw new Error(`TTS Error (${data.code}): ${data.message || 'Unknown error'}`);
              }
            } catch (e) {
              if (e.message.includes('TTS Error')) throw e;
              console.warn('è§£æå¤±è´¥:', line);
            }
          }
        }
        
        if (audioChunks.length === 0) {
          throw new Error('æœªæ”¶åˆ°éŸ³é¢‘æ•°æ®');
        }
        
        // åˆå¹¶éŸ³é¢‘
        const totalLength = audioChunks.reduce((sum, chunk) => sum + chunk.length, 0);
        const merged = new Uint8Array(totalLength);
        let offset = 0;
        for (const chunk of audioChunks) {
          merged.set(chunk, offset);
          offset += chunk.length;
        }
        
        // æ’­æ”¾éŸ³é¢‘
        const blob = new Blob([merged], { type: 'audio/mp3' });
        const url = URL.createObjectURL(blob);
        currentAudio = new Audio(url);
        currentAudio.play();
        
        button.textContent = 'â–¶ è¯•å¬';
      } catch (error) {
        console.error('è¯•å¬å¤±è´¥:', error);
        alert('è¯•å¬å¤±è´¥: ' + error.message);
        button.textContent = 'â–¶ è¯•å¬';
      } finally {
        button.disabled = false;
      }
    };

    // ä¿å­˜ TTS é…ç½®
    document.getElementById('btn-save-tts').addEventListener('click', async () => {
      const ttsAppId = document.getElementById('tts-app-id').value.trim();
      const ttsAccessToken = document.getElementById('tts-access-token').value.trim();
      const ttsSecretKey = document.getElementById('tts-secret-key').value.trim();
      const selectedVoice = document.querySelector('input[name="voice-select"]:checked');
      const ttsVoiceType = selectedVoice ? selectedVoice.value : 'zh_female_cancan_mars_bigtts';
      
      if (!ttsAppId || !ttsAccessToken || !ttsSecretKey) {
        showStatus('è¯·å¡«å†™ App IDã€Access Token å’Œ Secret Key', 'error');
        return;
      }
      
      // è‡ªåŠ¨æ ¹æ®éŸ³è‰²ç±»å‹è®¾ç½® Resource ID
      const ttsResourceId = getResourceId(ttsVoiceType);
      
      const settings = {
        qwenApiKey: providers.qwen.apiKey,
        qwenModels: providers.qwen.models,
        openrouterApiKey: providers.openrouter.apiKey,
        openrouterModels: providers.openrouter.models,
        currentModel: document.getElementById('llm-model').value,
        tts: {
          appId: ttsAppId,
          accessToken: ttsAccessToken,
          secretKey: ttsSecretKey,
          voiceType: ttsVoiceType,
          resourceId: ttsResourceId  // è‡ªåŠ¨è®¾ç½®
        }
      };
    
      try {
        await window.electronAPI.saveSettings(settings);
        showStatus('TTS é…ç½®å·²ä¿å­˜ï¼', 'success');
      } catch (error) {
        showStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
      }
    });

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatus(message, type) {
      const statusEl = document.getElementById('status-message');
      statusEl.textContent = message;
      statusEl.className = 'status ' + type;
      
      if (type === 'success') {
        setTimeout(() => {
          statusEl.className = 'status';
        }, 3000);
      }
    }

    // é¡µé¢åŠ è½½æ—¶åŠ è½½è®¾ç½®
    loadSettings();
  </script>
</body>
</html>
